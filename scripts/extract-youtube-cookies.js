#!/usr/bin/env node

/**
 * Script to extract YouTube cookies from browser and format them for yt-dlp
 * This helps bypass YouTube's bot detection
 */

const fs = require('fs');
const path = require('path');

// Instructions for extracting cookies
console.log(`
=================================================================
HOW TO EXTRACT YOUTUBE COOKIES FOR BOT DETECTION BYPASS
=================================================================

Option 1: Using Browser Developer Tools (Recommended)
------------------------------------------------------
1. Open YouTube.com in your browser and sign in
2. Open Developer Tools (F12)
3. Go to Application/Storage tab → Cookies → https://www.youtube.com
4. Look for these important cookies:
   - CONSENT (starts with "PENDING+" or "YES+")
   - __Secure-1PSID
   - __Secure-3PSID
   - LOGIN_INFO
   - PREF
   - VISITOR_INFO1_LIVE
   - YSC
   - SIDCC (optional but helpful)

5. Copy each cookie's name and value

Option 2: Using Browser Extensions
-----------------------------------
1. Install "EditThisCookie" or "Cookie-Editor" extension
2. Visit YouTube.com and sign in
3. Click the extension icon
4. Export cookies as Netscape format
5. Save to a file

Option 3: Using yt-dlp's built-in cookie extraction
----------------------------------------------------
Run locally (not on Cloud Run):
yt-dlp --cookies-from-browser chrome --cookies cookies.txt --skip-download https://www.youtube.com

Then use the generated cookies.txt file

=================================================================
FORMATTING COOKIES FOR CLOUD RUN
=================================================================

Once you have the cookies, you need to set them as an environment variable.

For semicolon-separated format (for YOUTUBE_COOKIES env var):
--------------------------------------------------------------
CONSENT=YES+cb.20210328-17-p0.en+FX+123; __Secure-1PSID=value1; __Secure-3PSID=value2; LOGIN_INFO=value3; VISITOR_INFO1_LIVE=value4; YSC=value5

For Netscape format file (youtube-cookies.txt):
------------------------------------------------
# Netscape HTTP Cookie File
.youtube.com	TRUE	/	TRUE	0	CONSENT	YES+cb.20210328-17-p0.en+FX+123
.youtube.com	TRUE	/	TRUE	0	__Secure-1PSID	value1
.youtube.com	TRUE	/	TRUE	0	__Secure-3PSID	value2
.youtube.com	TRUE	/	TRUE	0	LOGIN_INFO	value3
.youtube.com	TRUE	/	TRUE	0	VISITOR_INFO1_LIVE	value4
.youtube.com	TRUE	/	TRUE	0	YSC	value5

=================================================================
IMPORTANT NOTES
=================================================================
1. Cookies expire - you may need to refresh them periodically
2. Use cookies from an account that's not your main account
3. Don't share cookie values publicly as they contain session info
4. Cookies work best when from same region as your Cloud Run deployment

`);

// Function to convert semicolon-separated cookies to Netscape format
function convertToNetscapeFormat(cookieString, outputPath) {
  const cookies = cookieString.split(';').map(c => c.trim()).filter(c => c);

  let netscapeContent = '# Netscape HTTP Cookie File\n';
  netscapeContent += '# This file was generated by extract-youtube-cookies.js\n\n';

  cookies.forEach(cookie => {
    const [name, ...valueParts] = cookie.split('=');
    const value = valueParts.join('='); // Handle values with = signs

    if (name && value) {
      // Format: domain, flag, path, secure, expiration, name, value
      // Using 0 for expiration means session cookie (won't expire)
      // Using 1893456000 (year 2030) for longer persistence
      netscapeContent += `.youtube.com\tTRUE\t/\tTRUE\t1893456000\t${name.trim()}\t${value.trim()}\n`;
    }
  });

  fs.writeFileSync(outputPath, netscapeContent);
  console.log(`\nCookies saved to: ${outputPath}`);
  console.log('You can now use this file with yt-dlp: --cookies', outputPath);
}

// Check if cookies were provided as argument
if (process.argv[2]) {
  const outputPath = path.join(__dirname, '..', 'youtube-cookies.txt');
  convertToNetscapeFormat(process.argv[2], outputPath);

  console.log('\nTo use in Cloud Run, set the YOUTUBE_COOKIES environment variable:');
  console.log('gcloud run services update your-service --set-env-vars="YOUTUBE_COOKIES=' + process.argv[2] + '"');
} else {
  console.log('\nUsage: node extract-youtube-cookies.js "COOKIE1=value1; COOKIE2=value2"');
}